# Authorization Microservice Help

## Содержание

- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
  - [Сущности (Entities)](#сущности-entities)
  - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
  - [Репозитории (Repositories)](#репозитории-repositories)
  - [Сервисный слой (Services)](#сервисный-слой-services)
  - [Мапперы (Mappers)](#мапперы-mappers)
  - [Контроллер (Controller)](#контроллер-controller)
  - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
  - [Конфигурация](#конфигурация)
- [Основные API-сценарии](#основные-api-сценарии)
  - [Создание пользователя](#1-создание-пользователя)
  - [Обновление пользователя](#2-обновление-пользователя)
  - [Удаление пользователя](#3-удаление-пользователя)
  - [Получение пользователей](#4-получение-пользователей)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

## Описание модуля

Authorization Microservice предназначен для управления пользователями и их ролями, а также аудита их изменений. Основной функционал включает регистрацию, аутентификацию, управление ролями и ведение истории изменений.

## Функциональные возможности

- REST API с CRUD-операциями.
- Логирование изменений в таблицу аудита (только `create` и `update`).
- Интеграция с PostgreSQL.
- JWT-аутентификация и управление ролями.
- Автоматическая генерация документации (Swagger/OpenAPI).

## Архитектура

### Сущности (Entities)

- `User` – модель пользователя.
- `Audit` – модель записи аудита.

### DTO (Data Transfer Objects)

- `UserDto` – передача данных о пользователе через API.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)

- `UserRepository` – управление данными пользователей.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)

- `UserService` – интерфейс CRUD-операций.
- `UserServiceImpl` – реализация бизнес-логики.
- `AuditService` – интерфейс аудита.
- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)

- `UserMapper` – преобразует сущности пользователей в DTO и обратно. Использует **MapStruct** и работает под управлением Spring&#x20;
- `AuditMapper` – преобразует сущности аудита в DTO и обратно. Использует **MapStruct**, но не требует Spring-интеграции.

### Контроллер (Controller)

- `UserController` – REST API для управления пользователями.

### AOP-слой (Audit Logging)

- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `UserServiceImpl`.
- Автоматически заполняет таблицу `Audit` при изменении данных пользователя.
- Логирует, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.
- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `UserServiceImpl`.
- Автоматически заполняет таблицу `Audit` при изменении данных пользователя.
- Логирует, кто и когда внес изменения.

### Конфигурация

- `SwaggerConfig` – настройка Swagger.

## Основные API-сценарии

### 1. Создание пользователя

- **POST** `/users`
- Создает запись в `User` и логирует в `Audit`.

### 2. Обновление пользователя

- **PUT** `/users/{id}`
- Обновляет данные в `User`, фиксирует изменения в `Audit`.

### 3. Удаление пользователя

- **DELETE** `/users/{id}`
- Удаляет запись (без логирования в аудит).

### 4. Получение пользователей

- **GET** `/users` – список всех пользователей.
- **GET** `/users/{id}` – данные конкретного пользователя.

## Технологический стек

- Java 17
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Lombok
- MapStruct
- Spring Security (JWT)
- Spring AOP
- Swagger/OpenAPI
- Logback (Slf4j)

## Обработка ошибок (Exception Handling)

- `GlobalExceptionHandler` – глобальный обработчик исключений для API.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные ответы с кодами ошибок.

## JWT-аутентификация

### Добавление JWT-токена

1. При успешной аутентификации (логин пользователя) сервер возвращает JWT-токен.
2. Клиент передает этот токен в заголовке `Authorization: Bearer <TOKEN>` при каждом запросе.
3. Фильтр безопасности проверяет токен и аутентифицирует пользователя.
4. В случае недействительного токена сервер возвращает `401 Unauthorized`.

## Безопасность

- API защищено JWT-аутентификацией.
- Разграничение доступа по ролям.
- Логируются действия пользователей.

## Логирование и мониторинг

- Используется `Slf4j` для логирования операций.
- Детализированные сообщения об ошибках.
- Логирование успешных и неуспешных операций.

## Развертывание

- Контейнеризация через Docker.
- Kubernetes (Helm Charts).
- Конфигурация через `application.yml`.

## Дополнительные требования

- Код соответствует принципам SOLID.
- Предусмотрены unit- и интеграционные тесты.
- Готовность к CI/CD (GitLab CI/GitHub Actions).

---

Этот документ поможет быстро развернуть и использовать микросервис.

