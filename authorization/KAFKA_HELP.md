# Authorization Microservice Help (Kafka Edition)

## Содержание

- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
    - [Сущности (Entities)](#сущности-entities)
    - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
    - [Репозитории (Repositories)](#репозитории-repositories)
    - [Сервисный слой (Services)](#сервисный-слой-services)
    - [Мапперы (Mappers)](#мапперы-mappers)
    - [Контроллер (Controller)](#контроллер-controller)
    - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
    - [Конфигурация](#конфигурация)
- [Основные сценарии Kafka](#основные-сценарии-kafka)
    - [Создание учетной записи](#1-создание-учетной-записи)
    - [Обновление учетной записи](#2-обновление-учетной-записи)
    - [Удаление учетной записи](#3-удаление-учетной-записи)
    - [Получение учетных записей](#4-получение-учетных-записей)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

---

## Описание модуля

Authorization Microservice отвечает за управление авторизацией пользователей, аутентификацией и безопасностью системы.

## Функциональные возможности

- Взаимодействие с другими сервисами через **Kafka**.
- JWT-аутентификация.
- Интеграция с **PostgreSQL**.
- Автоматическая генерация документации (**Swagger/OpenAPI**).
- Логирование изменений в таблицу **Audit** (через **AOP**).
- Использование **констант или Enum**, где это целесообразно (например, для ролей и типов операций).

---

## Архитектура

### Сущности (Entities)

- `User` – модель пользователя.
- `Role` – роли пользователей.
- `Audit` – запись аудита.

### DTO (Data Transfer Objects)

- `UserDto` – передача данных пользователя.
- `RoleDto` – передача данных роли.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)

- `UserRepository` – управление пользователями.
- `RoleRepository` – управление ролями.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)

- `UserService` – интерфейс CRUD-операций.
- `UserServiceImpl` – реализация бизнес-логики.
- `RoleService` – интерфейс CRUD-операций для ролей.
- `RoleServiceImpl` – реализация логики ролей.
- `AuditService` – интерфейс аудита.
- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)

- `UserMapper` – преобразует сущности пользователей в DTO и обратно.
- `AuditMapper` – преобразует сущности аудита в DTO и обратно.

### Контроллер (Controller)

**Контроллеров нет, взаимодействие идет через Kafka.**

### AOP-слой (Audit Logging)

- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `UserServiceImpl`.
- Автоматически заполняет таблицу `Audit` при изменении данных пользователя.
- Логирует, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.

### Конфигурация

- `KafkaConfig` – настройка Kafka.
- `SwaggerConfig` – настройка Swagger.

---

## Основные сценарии Kafka

### 1. Создание учетной записи

- **Producer** отправляет сообщение в топик `user.create`.
- **Consumer** обрабатывает создание пользователя.

### 2. Обновление учетной записи

- **Producer** отправляет сообщение в топик `user.update`.
- **Consumer** обновляет данные пользователя.

### 3. Удаление учетной записи

- **Producer** отправляет сообщение в топик `user.delete`.
- **Consumer** удаляет пользователя.

### 4. Получение учетных записей

- **Producer** отправляет запрос в топик `user.get`.
- **Consumer** отвечает с нужными данными.

---

## Технологический стек

- **Java 17**
- **Spring Boot 3.x**
- **Spring Data JPA**
- **Spring Kafka**
- **PostgreSQL**
- **Lombok**
- **MapStruct**
- **Spring Security (JWT)**
- **Swagger/OpenAPI**
- **Logback (Slf4j)**

---

## Обработка ошибок (Exception Handling)

- `GlobalExceptionHandler` – глобальный обработчик исключений для Kafka-сообщений.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные ответы с кодами ошибок.

---

## Безопасность

- Взаимодействие сервисов через Kafka **шифруется**.
- Пользователи авторизуются через **JWT-токены**.
- Логируются все действия пользователей.

---

## Логирование и мониторинг

- **Slf4j** для логирования операций.
- **Kafka Monitoring** – отслеживание сообщений.
- **Prometheus + Grafana** – мониторинг производительности.

---

## Развертывание

- Контейнеризация через **Docker**.
- **Kubernetes (Helm Charts)**.
- Конфигурация через `application.yml`.

---

## Дополнительные требования

- Код **соответствует принципам SOLID**.
- **Использование констант или Enum** для предсказуемости данных.
- **Unit- и интеграционные тесты** с покрытием 80% (JUnit 5 + Mockito).
- Подключение к **CI/CD (GitLab CI/GitHub Actions)**.

---

Этот документ поможет быстро развернуть и использовать микросервис.
