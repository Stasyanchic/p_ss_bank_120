# Public Info Microservice Help (Kafka Edition)

## Содержание

- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
    - [Сущности (Entities)](#сущности-entities)
    - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
    - [Репозитории (Repositories)](#репозитории-repositories)
    - [Сервисный слой (Services)](#сервисный-слой-services)
    - [Мапперы (Mappers)](#мапперы-mappers)
    - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
    - [Конфигурация](#конфигурация)
- [Основные Kafka-сценарии](#основные-kafka-сценарии)
    - [Создание банка](#1-создание-банка)
    - [Обновление данных банка](#2-обновление-данных-банка)
    - [Удаление данных банка](#3-удаление-данных-банка)
    - [Получение информации о банке](#4-получение-информации-о-банке)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

---

## Описание модуля

**Public Info Microservice** предназначен для управления публичной информацией о банках, их отделениях, банкоматах, лицензиях и сертификатах. Также он ведет аудит изменений. Взаимодействие с другими сервисами осуществляется через **Apache Kafka**.

## Функциональные возможности

- Взаимодействие через **Kafka** для обработки сообщений вместо REST API.
- Логирование изменений в таблицу `audit` с использованием **AOP**.
- Интеграция с **PostgreSQL**.
- **JWT-аутентификация**.
- **Автоматическая генерация документации** (Swagger/OpenAPI).
- Использование **констант или Enum** для предсказуемости данных (например, для типов операций в аудите).

---

## Архитектура

### Сущности (Entities)

- `BankDetails` – информация о банке.
- `Branch` – отделения банка.
- `ATM` – информация о банкоматах.
- `License` – лицензии банка.
- `Certificate` – сертификаты банка.
- `Audit` – запись аудита изменений.

### DTO (Data Transfer Objects)

- `BankDetailsDto` – передача данных о банке через Kafka.
- `BranchDto` – передача данных об отделениях банка.
- `AtmDto` – передача данных о банкоматах.
- `LicenseDto` – передача данных о лицензиях.
- `CertificateDto` – передача данных о сертификатах.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)

- `BankDetailsRepository` – управление записями о банках.
- `BranchRepository` – управление записями об отделениях.
- `AtmRepository` – управление записями о банкоматах.
- `LicenseRepository` – управление лицензиями.
- `CertificateRepository` – управление сертификатами.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)

- `BankDetailsService` – интерфейс CRUD-операций для банков.
- `BankDetailsServiceImpl` – реализация бизнес-логики.
- `BranchService` – интерфейс CRUD-операций для отделений.
- `BranchServiceImpl` – реализация бизнес-логики.
- `AtmService` – интерфейс CRUD-операций для банкоматов.
- `AtmServiceImpl` – реализация бизнес-логики.
- `LicenseService` – интерфейс CRUD-операций для лицензий.
- `LicenseServiceImpl` – реализация бизнес-логики.
- `CertificateService` – интерфейс CRUD-операций для сертификатов.
- `CertificateServiceImpl` – реализация бизнес-логики.
- `AuditService` – интерфейс для работы с аудитом.
- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)

- `BankDetailsMapper` – преобразует сущности банков в DTO и обратно. Использует **MapStruct**.
- `AuditMapper` – преобразует сущности аудита в DTO и обратно.

### AOP-слой (Audit Logging)

- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в сервисах.
- Автоматически заполняет таблицу `Audit` при изменении данных.
- Записывает, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.

### Конфигурация

- `KafkaConfig` – настройка Kafka.

---

## Основные Kafka-сценарии

### 1. Создание банка

- **Топик:** `public-info.bank.create`
- Отправляет сообщение о создании записи в `BankDetails` и логирует в `Audit`.

### 2. Обновление данных банка

- **Топик:** `public-info.bank.update`
- Отправляет сообщение об обновлении данных в `BankDetails`, фиксирует изменения в `Audit`.

### 3. Удаление данных банка

- **Топик:** `public-info.bank.delete`
- Отправляет сообщение об удалении записи в `BankDetails` (без логирования в аудит).

### 4. Получение информации о банке

- **Топик:** `public-info.bank.get`
- Отправляет запрос на получение информации о банке.

---

## Технологический стек

- Java 17
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Lombok
- MapStruct
- Spring Security (JWT)
- Spring AOP
- Apache Kafka
- Swagger/OpenAPI
- Logback (Slf4j)

---

## Обработка ошибок (Exception Handling)

- `GlobalExceptionHandler` – глобальный обработчик исключений для Kafka.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные ответы с кодами ошибок.

---

## Безопасность

- API взаимодействует через Kafka, но авторизация выполняется с помощью **JWT**.
- Логируются действия пользователей.

---

## Логирование и мониторинг

- Используется `Slf4j` для логирования операций.
- Детализированные сообщения об ошибках.
- Логирование успешных и неуспешных операций.

---

## Развертывание

- Контейнеризация через Docker.
- Kubernetes (Helm Charts).
- Конфигурация через `application.yml`.

---

## Дополнительные требования

- Код соответствует принципам SOLID.
- Использование **констант или Enum** для предсказуемости данных.
- Предусмотрены unit- и интеграционные тесты.
- Готовность к CI/CD (GitLab CI/GitHub Actions).

---
