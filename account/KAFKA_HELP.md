# Account Microservice Help (Kafka Edition)

## Содержание
- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
    - [Сущности (Entities)](#сущности-entities)
    - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
    - [Репозитории (Repositories)](#репозитории-repositories)
    - [Сервисный слой (Services)](#сервисный-слой-services)
    - [Мапперы (Mappers)](#мапперы-mappers)
    - [Kafka Producer и Consumer](#kafka-producer-и-consumer)
    - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
    - [Конфигурация](#конфигурация)
- [Основные события Kafka](#основные-события-kafka)
    - [Создание учетной записи](#1-создание-учетной-записи)
    - [Обновление учетной записи](#2-обновление-учетной-записи)
    - [Удаление учетной записи](#3-удаление-учетной-записи)
    - [Получение учетных записей](#4-получение-учетных-записей)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

---

## Описание модуля
**Account Microservice (Kafka Edition)** предназначен для управления учетными записями через **Kafka**.
Вместо REST API используются **Kafka Producer** для отправки сообщений и **Kafka Consumer** для обработки событий.

---

## Функциональные возможности
- Обмен сообщениями через **Kafka**.
- Логирование изменений в таблицу **Audit** с использованием **AOP**.
- Интеграция с **PostgreSQL**.
- Автоматическая генерация документации **Swagger/OpenAPI** (для внутренних вызовов).
- Использование **констант или Enum**, где это целесообразно (например, для типов операций).

---

## Архитектура

### Сущности (Entities)
- `Account` – модель учетной записи.
- `Audit` – модель записи аудита.

### DTO (Data Transfer Objects)
- `AccountDto` – передача данных учетной записи через Kafka.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)
- `AccountRepository` – управление учетными записями.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)
- `AccountService` – интерфейс CRUD-операций.
- `AccountServiceImpl` – реализация бизнес-логики.
- `AuditService` – интерфейс аудита.
- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)
- `AccountMapper` – преобразует сущности учетных записей в DTO и обратно.
- `AuditMapper` – преобразует сущности аудита в DTO и обратно.

### Kafka Producer и Consumer
- `AccountProducer` – публикует сообщения об изменениях учетной записи в Kafka.
- `AccountConsumer` – слушает топики Kafka и обрабатывает события учетных записей.
- `AuditProducer` – отправляет в Kafka информацию об изменениях в системе.
- `AuditConsumer` – получает сообщения аудита и сохраняет их в БД.

### AOP-слой (Audit Logging)
- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `AccountServiceImpl`.
- Автоматически отправляет события аудита в Kafka.
- Логирует, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.

### Конфигурация
- `KafkaConfig` – конфигурация Kafka для продюсеров и консюмеров.
- `SwaggerConfig` – настройка Swagger.

---

## Основные события Kafka

### 1. Создание учетной записи
- **Topic:** `account.create`
- **Производитель:** `AccountProducer`
- **Потребитель:** `AccountConsumer`
- **Действие:** Создание учетной записи, запись в базу данных, логирование в Audit.

### 2. Обновление учетной записи
- **Topic:** `account.update`
- **Производитель:** `AccountProducer`
- **Потребитель:** `AccountConsumer`
- **Действие:** Обновление данных учетной записи, запись в Audit.

### 3. Удаление учетной записи
- **Topic:** `account.delete`
- **Производитель:** `AccountProducer`
- **Потребитель:** `AccountConsumer`
- **Действие:** Удаление записи, без логирования в Audit.

### 4. Получение учетных записей
- **Topic:** `account.get`
- **Производитель:** `AccountConsumer`
- **Действие:** Получение списка учетных записей.

---

## Технологический стек
- Java 17
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Kafka
- Lombok
- MapStruct
- Spring Security (JWT)
- Spring AOP
- Swagger/OpenAPI
- Logback (Slf4j)

---

## Обработка ошибок (Exception Handling)
- `GlobalExceptionHandler` – глобальный обработчик исключений для Kafka-сообщений.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные ошибки и ретраи в Kafka.

---

## Безопасность
- Kafka соединение защищено (SSL, SASL).
- JWT-аутентификация.
- Логируются действия пользователей.

---

## Логирование и мониторинг
- Используется `Slf4j` для логирования операций Kafka.
- Мониторинг через **Prometheus и Grafana**.
- Логирование успешных и неуспешных операций.

---

## Развертывание
- Контейнеризация через **Docker**.
- Оркестрация через **Kubernetes (Helm Charts)**.
- Конфигурация через `application.yml`.

---

## Дополнительные требования
- Код соответствует принципам **SOLID**.
- Использование **констант или Enum** для предсказуемости данных.
- Предусмотрены **unit- и интеграционные тесты**.
- Готовность к CI/CD (**GitLab CI/GitHub Actions**).

---

