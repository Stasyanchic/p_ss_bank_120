# Profile Microservice Help (Kafka Edition)

## Содержание

- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
    - [Сущности (Entities)](#сущности-entities)
    - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
    - [Репозитории (Repositories)](#репозитории-repositories)
    - [Сервисный слой (Services)](#сервисный-слой-services)
    - [Мапперы (Mappers)](#мапперы-mappers)
    - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
    - [Конфигурация Kafka](#конфигурация-kafka)
- [Основные сценарии обработки сообщений](#основные-сценарии-обработки-сообщений)
    - [Создание профиля](#1-создание-профиля)
    - [Обновление профиля](#2-обновление-профиля)
    - [Удаление профиля](#3-удаление-профиля)
    - [Получение профиля](#4-получение-профиля)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

## Описание модуля

Profile Microservice отвечает за управление пользовательскими профилями, их регистрацией и паспортными данными. Взаимодействие с другими сервисами происходит через Apache Kafka. Также ведется история изменений через систему аудита.

## Функциональные возможности

- Обмен сообщениями через Kafka.
- Логирование изменений в таблицу аудита (только `create` и `update`).
- Интеграция с PostgreSQL.
- JWT-аутентификация.
- Автоматическая генерация документации (Swagger/OpenAPI) для управления сервисом.

## Архитектура

### Сущности (Entities)

- `Profile` – основная модель профиля пользователя.
- `Passport` – паспортные данные пользователя.
- `Registration` – регистрационные данные пользователя.
- `ActualRegistration` – фактический адрес проживания.
- `AccountDetails` – связь профиля с учетной записью.
- `Audit` – запись аудита.

### DTO (Data Transfer Objects)

- `ProfileDto` – передача данных профиля через Kafka.
- `PassportDto` – передача паспортных данных.
- `RegistrationDto` – передача регистрационных данных.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)

- `ProfileRepository` – управление профилями.
- `PassportRepository` – управление паспортными данными.
- `RegistrationRepository` – управление регистрацией.
- `ActualRegistrationRepository` – управление фактическим местом жительства.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)

- `ProfileService` – интерфейс CRUD-операций для профиля.

- `ProfileServiceImpl` – реализация бизнес-логики.

- `PassportService` – интерфейс CRUD-операций для паспортных данных.

- `PassportServiceImpl` – реализация бизнес-логики.

- `RegistrationService` – интерфейс CRUD-операций для регистрационных данных.

- `RegistrationServiceImpl` – реализация бизнес-логики.

- `ActualRegistrationService` – интерфейс CRUD-операций для фактического места жительства.

- `ActualRegistrationServiceImpl` – реализация бизнес-логики.

- `AccountDetailsService` – интерфейс CRUD-операций для связи профилей с учетными записями.

- `AccountDetailsServiceImpl` – реализация бизнес-логики.

- `AuditService` – интерфейс для работы с аудитом.

- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)

- `ProfileMapper` – преобразует сущности профиля в DTO и обратно. Использует **MapStruct** и работает под управлением Spring.
- `AuditMapper` – преобразует сущности аудита в DTO и обратно.

### AOP-слой (Audit Logging)

- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `ProfileServiceImpl`.
- Автоматически заполняет таблицу `Audit` при изменении данных профиля.
- Записывает, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.

### Конфигурация Kafka

- Используется `@KafkaListener` для обработки входящих сообщений.
- Продюсеры сообщений работают с `KafkaTemplate<String, ProfileDto>`.
- Настроены отдельные топики для каждой операции (`profile.create`, `profile.update`, `profile.delete`, `profile.get`).

## Основные сценарии обработки сообщений

### 1. Создание профиля

- **Топик:** `profile.create`
- **Продюсер:** отправляет сообщение в Kafka при создании профиля.
- **Консьюмер:** слушает сообщения из Kafka и создает профиль в базе данных.

### 2. Обновление профиля

- **Топик:** `profile.update`
- **Продюсер:** отправляет обновленные данные в Kafka.
- **Консьюмер:** получает сообщение и обновляет профиль в базе.

### 3. Удаление профиля

- **Топик:** `profile.delete`
- **Продюсер:** отправляет ID профиля для удаления.
- **Консьюмер:** слушает сообщения и удаляет профиль.

### 4. Получение профиля

- **Топик:** `profile.get`
- **Продюсер:** отправляет запрос в Kafka на получение данных.
- **Консьюмер:** получает запрос, извлекает данные и отправляет в ответный топик.

## Технологический стек

- Java 17
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Lombok
- MapStruct
- Spring Security (JWT)
- Spring AOP
- Apache Kafka
- Swagger/OpenAPI
- Logback (Slf4j)

## Обработка ошибок (Exception Handling)

- `GlobalExceptionHandler` – глобальный обработчик исключений для микросервиса.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные сообщения об ошибках в топик `profile.errors`.

## Безопасность

- Используется Spring Security для авторизации.
- JWT используется для контроля доступа к Kafka-сообщениям.

## Логирование и мониторинг

- Логирование операций через `Slf4j`.
- Мониторинг Kafka с помощью **Micrometer** и **Prometheus**.
- Ошибки отправляются в топик `profile.errors`.

## Развертывание

- Контейнеризация через Docker.
- Kubernetes (Helm Charts).
- Kafka и Zookeeper управляются через `Strimzi`.

## Дополнительные требования

- Код соответствует принципам SOLID.
- Использование **констант или Enum** для предсказуемости данных.
- Поддерживаются unit- и интеграционные тесты.
- Готовность к CI/CD (GitLab CI/GitHub Actions).

---

Этот документ поможет быстро развернуть и использовать микросервис.
